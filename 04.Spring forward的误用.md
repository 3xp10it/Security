#04.Spring forward的误用

##4.1 All Input is Evil
  ___不要信任用户输入___，这是防御性编程里的法则之一。在实际的开发实践中，我们务必假设用户的输入都是恶意的，在程序处理过程中一定要对用户输入的数据进行检查，否则，程序可能会脱离我们预定的逻辑轨道运行。这很容易让恶意用户（攻击者）发起攻击并入侵系统，从而造成不必要的损失。
  
  例如下列漏洞都是没有对用户的输入进行足够的安全检查从而引发的漏洞：
  
  * XSS: 跨站点脚本攻击
  * SQL Inject: SQL注入
  * 上传文件漏洞
  * 下载文件漏洞
  * ......

##4.2 String Return Type of Controller in Spring MVC
  
  Spring MVC是Java非常流行的Web框架之一，在Java Web开发中，几乎到了不可或缺的地步。Spring MVC为我们封装了很多底层的实现，从而让Javaer使用起来简单便捷。
  
  但是即使再优秀的框架，如果没有防御性编程的意识，那么很容易引发各式各样的漏洞，甚至更多的情况下是由于程序员的__小聪明__而导致的漏洞。
  
  描述这样一个应用场景：security路径下有0.jsp...9.jsp十个jsp页面。某程序员为了减少代码量，可能会这样写：

```
@RequestMapping("/security/{path}")
public void process() {
}
```
  在正常情况下，url与请求页面的映射如下：

  * http://localhost/security/1  -->  /security/1.jsp  --> 200
  * http://localhost/security/2  -->  /security/2.jsp  --> 200
  
  我们知道，在Spring MVC中，Controller方法的返回值如果的String或void类型的话，那么RequestMapping的值或返回的String会被当做一个试图进行解析。假设protected.jsp是被Spring Security过滤器保护的资源，只有管理员权限才能访问：

Spring Security配置如下：

```xml
<http>
	<intercept-url pattern="/security/protected" access="ROLE_ADMIN" />
	<intercept-url pattern="/security/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />
</http>
```

请求未授权的页面会返回403页面：

  * http://localhost/security/proected  -->  /security/proteced.jsp --> 403
  
  这似乎也没有多大的问题，/security/protected这个URL已经被保护了，只有管理员才能访问。那这里真的没有可以利用的BUG？我看未必，且看以下URL如何：
  
  * http://localhost/security/forward:protected  -->  /security/protected.jsp --> 200
  
  我们这里利用Spring MVC的forward指令成功绕过了被保护的URL资源。

###4.3 容易出现缺陷的做法
```java
@RequestMapping("/security/process")
public String process(@RequestParam("path") String path) {
  return path;
}
```
```java
@RequestMapping("/security/{path}")
public String process(@PathVariable("path") String path) {
  return path;
}
```

###4.4 How to Fix It

URL:http://localhost/security/process?path=forward:/security/others

URL:http://localhost/security/forward:/security/others

##4.5 
	
	* All Input is Evil

	* 最低权限原则
	
	* 白名单为主，黑名单为辅
	

####问了好玩的问题：

* /security/1  /security/2 /seucrity/3  .... 是匿名用户可以访问的页面
* /security/protected 是管理员权限才可以访问的页面

假如，Controller如是写：
```java
@RequestMapping("/security/process")
public Sting process(@RequestParam("value") String value) {
	return vaue;
}
@RequestMapping("/security/protected")
public void process2(){
}
```
Spring Security配置如下：
```xml
<http>
    <intercept-url pattern="/security/protected" access="ROLE_ADMIN" />
    <intercept-url pattern="/security/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />
</http>
```

这样有何问题？（Spring Security配置是正确的）
